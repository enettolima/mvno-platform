<!-- Iconpicker -->
<link href="/lib/js/iconpicker/css/fontawesome-iconpicker.min.css" rel="stylesheet" type="text/css" />

<section class="content-header">
<h1>
  {% block page_title %}
    {{ page_title }}
  {% endblock %}
  <small>{% block page_subtitle %} {{ page_subtitle }} {% endblock %}</small>
</h1>
<h4>{{ form_tips }}</h4>
<ol class="breadcrumb {{ hide_button }}">
  <li class="breadcrumb-home"><a href="javascript:menu_navigation('dashboard_main', 'dashboard_home', 'dashboard')">Dashboard</a></li>
</ol>
</section>

<div class="panel-body table-responsive">
  <div class="panel panel-default ">
    <div class="container">
     <legend>
       <div class="btn-group">
          <button type="button" class="btn btn-primary" onclick="javascript:process_information('', 'dashboard_widgets_graph_line_template', 'dashboard_widgets', null, null, null, null, null, 'POST')">Line</button>
          <button type="button" class="btn btn-selected" onclick="javascript:process_information('', 'dashboard_widgets_graph_area_template', 'dashboard_widgets', null, null, null, null, null, 'POST')">Area</button>
          <button type="button" class="btn btn-primary" onclick="javascript:process_information('', 'dashboard_widgets_graph_bar_template', 'dashboard_widgets', null, null, null, null, null, 'POST')">Bar</button>
          <button type="button" class="btn btn-primary" onclick="javascript:process_information('', 'dashboard_widgets_graph_donut_template', 'dashboard_widgets', null, null, null, null, null, 'POST')">Donut</button>
          <button type="button" class="btn btn-primary" onclick="javascript:process_information('', 'dashboard_widgets_graph_temp_template', 'dashboard_widgets', null, null, null, null, null, 'POST')">Template</button>
       </div>
     </legend>
       <form id="form_chart" data-disable="false" data-toggle="validator" data-id="customer_signup_form" name="form_chart" method="POST" class="">
               <input name="graph_type" type="hidden" value="Area">
               <input name="widget_function" type="hidden" value="render_widget_graph">
               <input name="enabled" type="hidden" value="1">
               <legend>Area Graphic</legend>
               <div class="form-group col-lg-4">
                 <label>Title</label>
                 <input type="text" data-minlength="3" name="title" class="form-control" id="title" value="Customers / Month" data-error="The field company is required." data-toggle="tooltip" data-placement="top" title="This is the widget title." required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-4">
                 <label>Description</label>
                 <input type="text" data-minlength="3" name="description" class="form-control" id="description" value="This is an description example." data-error="The field is required." data-toggle="tooltip" data-placement="top" title="This is just an description of the widget to inform the user what is the widget about." required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-4">
                 <label>Subject</label>
                 <input type="text" data-minlength="3" name="subject" class="form-control" id="subject" value="" data-error="The field is required.">
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-4">
                 <label>Class</label>
                 <input type="text" data-minlength="3" name="class" class="form-control" id="class" value="ui-state-default" data-error="The field is required." required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-2">
                 <label for="sel1">Icon</label>
                 <div class="input-group iconpicker-container">
                       <input data-placement="bottomRight" name="icon" class="form-control icp icp-auto iconpicker-element iconpicker-input" value="fa-archive" type="text"  data-toggle="tooltip" data-placement="top" title="Select the icon that will appear at the widget box." >
                       <span class="input-group-addon"><i class="fa fa-archive"></i></span>
                 </div>
               </div>
               <legend>Grid Options</legend>
               <div class="form-group col-lg-2">
                 <label>data-gs-x</label>
                 <input type="num" data-minlength="1" name="data_gs_x" class="form-control" id="data_gs_x" value="0" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="data-gs-x, data-gs-y - element position;  data-gs-width, data-gs-height - element size;" required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-2">
                 <label>data-gs-y</label>
                 <input type="num" data-minlength="1" name="data_gs_y" class="form-control" id="data_gs_y" value="0" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="data-gs-x, data-gs-y - element position;  data-gs-width, data-gs-height - element size;" required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-2">
                 <label>data-gs-width</label>
                 <input type="num" data-minlength="1" name="data_gs_width" class="form-control" id="data_gs_width" value="4" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="data-gs-x, data-gs-y - element position;  data-gs-width, data-gs-height - element size;" required>
                 <span class="help-block with-errors"></span>
               </div>
               <div class="form-group col-lg-2">
                 <label>data-gs-height</label>
                 <input type="num" data-minlength="1" name="data_gs_height" class="form-control" id="data_gs_height" value="3" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="data-gs-x, data-gs-y - element position;  data-gs-width, data-gs-height - element size;" required>
                 <span class="help-block with-errors"></span>
               </div>


               <legend>Response when there is no Data</legend>
               <div class="form-group col-lg-12">
                 <label>No Data Response</label>
                 <input type="text" data-minlength="3" name="response_nodata" class="form-control" id="response_nodata" value="<div><div class=''medium-number''>No Data</div><div class=''dash-click-list''>There is no data to show right now.</div></div>" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="This is your html code to show when the query does not return data and the graphic will be empty. If this is set, than it will show instead of empty graphic." required>
                 <span class="help-block with-errors"></span>
               </div>

               <legend>Chart Options ( <a target="_new" href='http://morrisjs.github.io/morris.js/lines.html'>Morris Line Chart Documentation</a>)</legend>
               <p></p>
               <div class="form-group col-lg-2">
                 <label>Auto Reload</label>
                 <input type="num" data-minlength="1" name="update_seconds" class="form-control" id="update_seconds" value="0" data-error="The field is required."  data-toggle="tooltip" data-placement="top" title="This is the number of seconds to auto reload the graphic. If you set 0 it will turn the auto reload off." required>
                 <span class="help-block with-errors"></span>
               </div>

               <div class="form-group col-lg-2">
                 <label for="sel1">axes</label>
                 <select class="form-control" id="axes" name="graph_options[axes]"  data-toggle="tooltip" data-placement="top" title="Set to false to disable drawing the x and y axes.">
                   <option>True</option>
                   <option>False</option>
                 </select>
               </div>

               <div class="form-group col-lg-2">
                 <label for="sel1">grid</label>
                 <select class="form-control" id="grid" name="graph_options[grid]"  data-toggle="tooltip" data-placement="top" title="Set to false to disable drawing the horizontal grid lines.">
                   <option>True</option>
                   <option>False</option>
                 </select>
               </div>

               <div class="form-group colorpick col-lg-2">
                 <label>Grid Text Color</label>
                 <div class="input-group iconpicker-container">
                   <input type="text" data-minlength="3" name="graph_options[gridTextColor]" class="form-control" id="gridTextColor" value="#888" data-error="The field is required."  data-toggle="tooltip" data-placement="top" title="Set the color of the axis labels (default: #888)." required>
                   <span class="input-group-addon"><i></i></span>
                 </div>
                 <span class="help-block with-errors"></span>
               </div>

               <div class="form-group col-lg-2">
                 <label>gridTextFamily</label>
                 <input type="text" data-minlength="3" name="graph_options[gridTextFamily]" class="form-control" id="gridTextFamily" value="sans-serif" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="Set the font family of the axis labels (default: sans-serif)." required>
                 <span class="help-block with-errors"></span>
               </div>

               <div class="form-group col-lg-1">
                 <label>gridTextSize</label>
                 <input type="num" data-minlength="1" name="graph_options[gridTextSize]" class="form-control" id="gridTextSize" value="12" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="Set the point size of the axis labels (default: 12)." required>
                 <span class="help-block with-errors"></span>
               </div>


               <div class="form-group col-lg-2">
                 <label>gridTextWeight</label>
                 <input type="text" data-minlength="3" name="graph_options[gridTextWeight]" class="form-control" id="gridTextWeight" value="normal" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="Set the font weight of the axis labels (default: normal)." required>
                 <span class="help-block with-errors"></span>
               </div>

               <div class="form-group col-lg-2">
                 <label>postUnits</label>
                 <input type="text" name="graph_options[postUnits]" class="form-control" id="fillOpacity" value="" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="Set to a string value (eg: '%') to add a label suffix all y-labels.">
                 <span class="help-block with-errors"></span>
               </div>

               <div class="form-group col-lg-2">
                 <label>preUnits</label>
                 <input type="text"  name="graph_options[postUnits]" class="form-control" id="fillOpacity" value="" data-error="The field is required." data-toggle="tooltip" data-placement="top" title="Set to a string value (eg: '$') to add a label prefix all y-labels.">
                 <span class="help-block with-errors"></span>
               </div>

              <div class="form-group col-lg-2">
                 <label for="sel1">xLabels</label>
                 <select class="form-control" id="xLabels" name="graph_options[xLabels]"  data-toggle="tooltip" data-placement="top" title="Sets the x axis labelling interval. By default the interval will be automatically computed.">
                   <option></option>
                   <option>decade</option>
                   <option>year</option>
                   <option>month</option>
                   <option>week</option>
                   <option>day</option>
                   <option>hour</option>
                   <option>30min</option>
                   <option>15min</option>
                   <option>10min</option>
                   <option>5min</option>
                   <option>minute</option>
                   <option>30sec</option>
                   <option>15sec</option>
                   <option>10sec</option>
                   <option>5sec</option>
                   <option>second</option>
                 </select>
               </div>

               <div class="form-group col-lg-2">
                 <label>fillOpacity</label>
                 <input type="text" data-minlength="3" name="graph_options[fillOpacity]" class="form-control" id="fillOpacity" value="" data-error="The field is required."  data-toggle="tooltip" data-placement="top" title="Change the opacity of the area fill colour. Accepts values between 0.0 (for completely transparent) and 1.0 (for completely opaque).">
                 <span class="help-block with-errors"></span>
               </div>

               <legend>Query ( <a target="_new" href='http://morrisjs.github.io/morris.js/lines.html'>Morris Line Chart Documentation</a>)</legend>
               <div class="form-group col-lg-13">
                 <label>Construct your query</label>
                 <input type="text" data-minlength="3" name="query" class="form-control" id="query" value="select a, b, c, d ,e, date from natural_dummy_data group by month(date)" data-error="The field is required." required>
                 <span class="help-block with-errors"></span>
               </div>
                <section gs-morris-array="" id="morris_data">
                  <div id="xkey"               gs-morris-type="ratio" gs-morris-size="2" gs-morris-disable="true" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="ykeys"               gs-morris-type="textkey" gs-morris-readonly="true" gs-morris-size="2"  gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="labels"             gs-morris-type="text" gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="linecolors"         gs-morris-type="color"  gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="lineWidth"          gs-morris-type="number" gs-morris-value="3" gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="pointSize"          gs-morris-type="number" gs-morris-value="5" gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="pointFillColors"    gs-morris-type="color" gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                  <div id="pointStrokeColors"  gs-morris-type="color" gs-morris-type="color" gs-morris-size="2" gs-morris-required="true" gs-morris-validation="" data-minlength="1" data-morris-maxlength="1" class="row">
                  </div>
                </section>

                <legend></legend>
                <input type="submit" class="btn btn-success" value="Create Widget" data-original-title="" title="">
          </form>
    </div>
  </div>
</div>
<script type="text/javascript" src="lib/js/iconpicker/js/fontawesome-iconpicker.min.js"></script>
<script> $("input[id*='_input_']").prop('disabled', false);

  $('#form_chart').validator().on('submit', function (e) {
    $(":submit").attr("disabled", true);
    if (e.isDefaultPrevented()) {
      // handle the invalid form...
      $(":submit").attr("disabled", false);
    } else {
      // Prevent the form from submitting with the default action
      e.preventDefault();
      // everything looks good with validation
      process_information('form_chart', 'dashboard_widgets_create_form_submit', 'dashboard_widgets', null, null, null, null, null, 'POST');
    }
  })

  //add color picker to the field
    function updatefields(){
      var f, t = 0;
      var v = '';
      var fields = [];
      v = $('#query').val().toLowerCase();
      f = v.indexOf("select") + 6;
      t = v.indexOf("from");
      if(f > 0 && t > 0){
        fieldset   = $('#query').val().toLowerCase().substring(f, t).replace(/ /g,'').split(',');
        fieldsaved = $('#morris_data').attr('gs-morris-array').toLowerCase().replace(/ /g,'').split(',');
        $.each(fieldsaved, function( key, value ) {
             if($.inArray(value, fields) == -1){ // do not have on field
                 if($.inArray(value, fieldset) == -1){ //was removed from set
                   //we need to remove column here
                   morris_remove_field(value);
                 }else{
                   fields.push(value);
                 }
               }
        });
        $.each(fieldset, function( key, value ) {
             if($.inArray(value, fields) == -1){ // do not have on field
                 fields.push(value);
                 //new field. here we need to add column
                 morris_add_field(value);
               }
        });


        if(fieldsaved != fields){
          $('#morris_data').attr('gs-morris-array', fields);
        }
      }
    }

    function getRandomColor() {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++ ) {
          color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
     }

     function shadeColor2(color, percent) {
        var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
        return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
     }

    function morris_add_field(fieldname) {
       $('#morris_data').children().each(function(i, elm) {
           var id = $(this).attr('id');
           var required = '';
           var readonly = '';
           var value = '';
           if ($(this).attr('gs-morris-required') == 'true'){required = 'required';}
           if ($(this).attr('gs-morris-readonly') == 'true'){readonly = 'readonly';}

           switch ($(this).attr('gs-morris-type')) {
             case 'ratio':
               $(this).append("<div id='"+id+"_"+fieldname+"' class='form-group col-lg-"+$(this).attr('gs-morris-size')+"'><label><input id='"+id+"_input_"+fieldname+"' type='radio' name='graph_options[xkey]' value='"+fieldname+"' data-error='Required to select one of the option.' data-toggle='tooltip' data-placement='top' title='Select one of the column to be the xkey in the graphic.' required/>"+fieldname+"</label></div>");
               $("#"+id+"_input_"+fieldname).on( "click", function() {
                 $("input[id*='_input_']").prop('disabled', false);
                 $("input[id$='_input_"+fieldname+"']").prop('disabled', true);
                 $("input[id='xkey_input_"+fieldname+"']").prop('disabled', false);
               });
               break;
             case 'textkey':
               $(this).append("<div id='"+id+"_"+fieldname+"' class='form-group col-lg-"+$(this).attr('gs-morris-size')+"'><label>"+id+"</label><input id='"+id+"_input_"+fieldname+"' type='text' data-minlength='1' name='graph_options["+id+"][]' class='form-control' value='"+fieldname+"' data-error='The field is required.' "+required+" "+readonly+"><span class='help-block with-errors'></span></div>");
               break;
             case 'text':
               if ($(this).attr('id') == 'labels'){
                 value = $("#ykeys_input_"+fieldname).val();
               }
               $(this).append("<div id='"+id+"_"+fieldname+"' class='form-group col-lg-"+$(this).attr('gs-morris-size')+"'><label>"+id+"</label><input id='"+id+"_input_"+fieldname+"' type='text' data-minlength='1' name='graph_options["+id+"][]' class='form-control' value='"+value+"' data-error='The field is required.' "+required+" "+readonly+"><span class='help-block with-errors'></span></div>");
               break;
             case 'number':
               value = $(this).attr('gs-morris-value');
               $(this).append("<div id='"+id+"_"+fieldname+"' class='form-group col-lg-"+$(this).attr('gs-morris-size')+"'><label>"+id+"</label><input id='"+id+"_input_"+fieldname+"' type='num' data-minlength='1' name='graph_options["+id+"][]' class='form-control' value='"+value+"' data-error='The field is required.' "+required+" "+readonly+"><span class='help-block with-errors'></span></div>");
               break;
             case 'color':
               value = getRandomColor();
               if (id == 'pointFillColors'){
                 value = shadeColor2($('#linecolors_input_'+fieldname).val(), -0.3);
               }
               if (id == 'pointStrokeColors'){
                 value = shadeColor2($('#linecolors_input_'+fieldname).val(), +0.8);
               }
               $(this).append("<div id='"+id+"_"+fieldname+"' class='form-group colorpick col-lg-"+$(this).attr('gs-morris-size')+" '><label>"+id+"</label><div class='input-group iconpicker-container'><input id='"+id+"_input_"+fieldname+"' type='text' data-minlength='2' name='graph_options["+id+"][]' class='form-control' value='"+value+"' data-error='The field is required.' "+required+" "+readonly+"><span class='input-group-addon'><i></i></span></div><span class='help-block with-errors'></span></div>");
               $(function(){
                     $('.colorpick').colorpicker();
               });
               break;
             default:
              ''
           }
         });
     }



     //add first batch of field.
     function morris_remove_field(fieldname) {
            $('#morris_data').children().each(function(i, elm) {
                var id = $(this).attr('id');
                $("#"+id+"_"+fieldname).remove();
            });
    }

    $( "#query" ).keyup(function() {
        updatefields();
    });

    //will check if already have query and place fields
    $( document ).ready(function() {
      updatefields();
      $('.colorpick').colorpicker();
      $('[data-toggle="tooltip"]').tooltip()
      $('.icp-auto').iconpicker();
      $('.icp-dd').iconpicker({
          //title: 'Dropdown with picker',
          //component:'.btn > i'
      });

      $('.icp-glyphs').iconpicker({
          title: 'Prepending glypghicons',
          icons: $.merge(['glyphicon-home', 'glyphicon-repeat', 'glyphicon-search',
              'glyphicon-arrow-left', 'glyphicon-arrow-right', 'glyphicon-star'], $.iconpicker.defaultOptions.icons),
          fullClassFormatter: function(val){
              if(val.match(/^fa-/)){
                  return 'fa '+val;
              }else{
                  return 'glyphicon '+val;
              }
          }
      });
    });
  </script>
